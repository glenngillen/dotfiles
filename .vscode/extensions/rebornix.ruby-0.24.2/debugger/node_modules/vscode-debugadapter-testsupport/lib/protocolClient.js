"use strict";
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
Object.defineProperty(exports, "__esModule", { value: true });
const ee = require("events");
class ProtocolClient extends ee.EventEmitter {
    constructor() {
        super();
        this.pendingRequests = new Map();
        this.rawData = new Buffer(0);
        this.sequence = 1;
        this.contentLength = -1;
    }
    connect(readable, writable) {
        this.outputStream = writable;
        readable.on('data', (data) => {
            this.handleData(data);
        });
    }
    send(command, args) {
        return new Promise((completeDispatch, errorDispatch) => {
            this.doSend(command, args, (result) => {
                if (result.success) {
                    completeDispatch(result);
                }
                else {
                    errorDispatch(new Error(result.message));
                }
            });
        });
    }
    doSend(command, args, clb) {
        const request = {
            type: 'request',
            seq: this.sequence++,
            command: command
        };
        if (args && Object.keys(args).length > 0) {
            request.arguments = args;
        }
        // store callback for this request
        this.pendingRequests.set(request.seq, clb);
        const json = JSON.stringify(request);
        this.outputStream.write(`Content-Length: ${Buffer.byteLength(json, 'utf8')}\r\n\r\n${json}`, 'utf8');
    }
    handleData(data) {
        this.rawData = Buffer.concat([this.rawData, data]);
        while (true) {
            if (this.contentLength >= 0) {
                if (this.rawData.length >= this.contentLength) {
                    const message = this.rawData.toString('utf8', 0, this.contentLength);
                    this.rawData = this.rawData.slice(this.contentLength);
                    this.contentLength = -1;
                    if (message.length > 0) {
                        this.dispatch(message);
                    }
                    continue; // there may be more complete messages to process
                }
            }
            else {
                const idx = this.rawData.indexOf(ProtocolClient.TWO_CRLF);
                if (idx !== -1) {
                    const header = this.rawData.toString('utf8', 0, idx);
                    const lines = header.split('\r\n');
                    for (let i = 0; i < lines.length; i++) {
                        const pair = lines[i].split(/: +/);
                        if (pair[0] === 'Content-Length') {
                            this.contentLength = +pair[1];
                        }
                    }
                    this.rawData = this.rawData.slice(idx + ProtocolClient.TWO_CRLF.length);
                    continue;
                }
            }
            break;
        }
    }
    dispatch(body) {
        const rawData = JSON.parse(body);
        if (typeof rawData.event !== 'undefined') {
            const event = rawData;
            this.emit(event.event, event);
        }
        else {
            const response = rawData;
            const clb = this.pendingRequests.get(response.request_seq);
            if (clb) {
                this.pendingRequests.delete(response.request_seq);
                clb(response);
            }
        }
    }
}
ProtocolClient.TWO_CRLF = '\r\n\r\n';
exports.ProtocolClient = ProtocolClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdG9jb2xDbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcHJvdG9jb2xDbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Z0dBR2dHOztBQUdoRyw2QkFBNkI7QUFHN0IsTUFBYSxjQUFlLFNBQVEsRUFBRSxDQUFDLFlBQVk7SUFVbEQ7UUFDQyxLQUFLLEVBQUUsQ0FBQztRQUxELG9CQUFlLEdBQUcsSUFBSSxHQUFHLEVBQStDLENBQUM7UUFDekUsWUFBTyxHQUFHLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBSy9CLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUVTLE9BQU8sQ0FBQyxRQUF5QixFQUFFLFFBQXlCO1FBRXJFLElBQUksQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDO1FBRTdCLFFBQVEsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBWSxFQUFFLEVBQUU7WUFDcEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2QixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFrQ00sSUFBSSxDQUFDLE9BQWUsRUFBRSxJQUFVO1FBRXRDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxhQUFhLEVBQUUsRUFBRTtZQUN0RCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxNQUE4QixFQUFFLEVBQUU7Z0JBQzdELElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtvQkFDbkIsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ3pCO3FCQUFNO29CQUNOLGFBQWEsQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztpQkFDekM7WUFDRixDQUFDLENBQUMsQ0FBQztR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YUFDRDtZQUNELE1BQU07U0FDTjtJQUNGLENBQUM7SUFFTyxRQUFRLENBQUMsSUFBWTtRQUU1QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWpDLElBQUksT0FBTyxPQUFPLENBQUMsS0FBSyxLQUFLLFdBQVcsRUFBRTtZQUN6QyxNQUFNLEtBQUssR0FBeUIsT0FBTyxDQUFDO1lBQzVDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztTQUM5QjthQUFNO1lBQ04sTUFBTSxRQUFRLEdBQTRCLE9BQU8sQ0FBQztZQUNsRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDM0QsSUFBSSxHQUFHLEVBQUU7Z0JBQ1IsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUNsRCxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDZDtTQUNEO0lBQ0YsQ0FBQzs7QUF2SWMsdUJBQVEsR0FBRyxVQUFVLENBQUM7QUFGdEMsd0NBMElDIiwic291cmNlc0NvbnRlbnQiOlsiLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAqICBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuIFNlZSBMaWNlbnNlLnR4dCBpbiB0aGUgcHJvamVjdCByb290IGZvciBsaWNlbnNlIGluZm9ybWF0aW9uLlxuICotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovXG5cbmltcG9ydCBzdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTtcbmltcG9ydCAqIGFzIGVlIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQge0RlYnVnUHJvdG9jb2x9IGZyb20gJ3ZzY29kZS1kZWJ1Z3Byb3RvY29sJztcblxuZXhwb3J0IGNsYXNzIFByb3RvY29sQ2xpZW50IGV4dGVuZHMgZWUuRXZlbnRFbWl0dGVyIHtcblxuXHRwcml2YXRlIHN0YXRpYyBUV09fQ1JMRiA9ICdcXHJcXG5cXHJcXG4nO1xuXG5cdHByaXZhdGUgb3V0cHV0U3RyZWFtOiBzdHJlYW0uV3JpdGFibGU7XG5cdHByaXZhdGUgc2VxdWVuY2U6IG51bWJlcjtcblx0cHJpdmF0ZSBwZW5kaW5nUmVxdWVzdHMgPSBuZXcgTWFwPG51bWJlciwgKGU6IERlYnVnUHJvdG9jb2wuUmVzcG9uc2UpID0+IHZvaWQ+KCk7XG5cdHByaXZhdGUgcmF3RGF0YSA9IG5ldyBCdWZmZXIoMCk7XG5cdHByaXZhdGUgY29udGVudExlbmd0aDogbnVtYmVyO1xuXG5cdGNvbnN0cnVjdG9yKCkge1xuXHRcdHN1cGVyKCk7XG5cdFx0dGhpcy5zZXF1ZW5jZSA9IDE7XG5cdFx0dGhpcy5jb250ZW50TGVuZ3RoID0gLTE7XG5cdH1cblxuXHRwcm90ZWN0ZWQgY29ubmVjdChyZWFkYWJsZTogc3RyZWFtLlJlYWRhYmxlLCB3cml0YWJsZTogc3RyZWFtLldyaXRhYmxlKTogdm9pZCB7XG5cblx0XHR0aGlzLm91dHB1dFN0cmVhbSA9IHdyaXRhYmxlO1xuXG5cdFx0cmVhZGFibGUub24oJ2RhdGEnLCAoZGF0YTogQnVmZmVyKSA9PiB7XG5cdFx0XHR0aGlzLmhhbmRsZURhdGEoZGF0YSk7XG5cdFx0fSk7XG5cdH1cblxuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnaW5pdGlhbGl6ZScsIGFyZ3M6IERlYnVnUHJvdG9jb2wuSW5pdGlhbGl6ZVJlcXVlc3RBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkluaXRpYWxpemVSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdjb25maWd1cmF0aW9uRG9uZScsIGFyZ3M6IERlYnVnUHJvdG9jb2wuQ29uZmlndXJhdGlvbkRvbmVBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkNvbmZpZ3VyYXRpb25Eb25lUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnbGF1bmNoJywgYXJnczogRGVidWdQcm90b2NvbC5MYXVuY2hSZXF1ZXN0QXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5MYXVuY2hSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdhdHRhY2gnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkF0dGFjaFJlcXVlc3RBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkF0dGFjaFJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3Jlc3RhcnQnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlJlc3RhcnRBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlJlc3RhcnRSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdkaXNjb25uZWN0JywgYXJnczogRGVidWdQcm90b2NvbC5EaXNjb25uZWN0QXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5EaXNjb25uZWN0UmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc2V0QnJlYWtwb2ludHMnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlNldEJyZWFrcG9pbnRzQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5TZXRCcmVha3BvaW50c1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3NldEZ1bmN0aW9uQnJlYWtwb2ludHMnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlNldEZ1bmN0aW9uQnJlYWtwb2ludHNBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlNldEZ1bmN0aW9uQnJlYWtwb2ludHNSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdzZXRFeGNlcHRpb25CcmVha3BvaW50cycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU2V0RXhjZXB0aW9uQnJlYWtwb2ludHNBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlNldEV4Y2VwdGlvbkJyZWFrcG9pbnRzUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnY29udGludWUnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkNvbnRpbnVlQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5Db250aW51ZVJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ25leHQnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLk5leHRBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLk5leHRSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdzdGVwSW4nLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlN0ZXBJbkFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU3RlcEluUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc3RlcE91dCcsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU3RlcE91dEFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU3RlcE91dFJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3N0ZXBCYWNrJywgYXJnczogRGVidWdQcm90b2NvbC5TdGVwQmFja0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU3RlcEJhY2tSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdyZXZlcnNlQ29udGludWUnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlJldmVyc2VDb250aW51ZUFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuUmV2ZXJzZUNvbnRpbnVlUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAncmVzdGFydEZyYW1lJywgYXJnczogRGVidWdQcm90b2NvbC5SZXN0YXJ0RnJhbWVBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlJlc3RhcnRGcmFtZVJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2dvdG8nLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkdvdG9Bcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkdvdG9SZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdwYXVzZScsIGFyZ3M6IERlYnVnUHJvdG9jb2wuUGF1c2VBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlBhdXNlUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc3RhY2tUcmFjZScsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU3RhY2tUcmFjZUFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU3RhY2tUcmFjZVJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3Njb3BlcycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU2NvcGVzQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5TY29wZXNSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICd2YXJpYWJsZXMnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlZhcmlhYmxlc0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuVmFyaWFibGVzUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc2V0VmFyaWFibGUnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlNldFZhcmlhYmxlQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5TZXRWYXJpYWJsZVJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3NvdXJjZScsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU291cmNlQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5Tb3VyY2VSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICd0aHJlYWRzJykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuVGhyZWFkc1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ21vZHVsZXMnKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5Nb2R1bGVzUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnZXZhbHVhdGUnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkV2YWx1YXRlQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5FdmFsdWF0ZVJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3N0ZXBJblRhcmdldHMnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlN0ZXBJblRhcmdldHNBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlN0ZXBJblRhcmdldHNSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdnb3RvVGFyZ2V0cycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuR290b1RhcmdldHNBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkdvdG9UYXJnZXRzUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnY29tcGxldGlvbnMnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkNvbXBsZXRpb25zQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5Db21wbGV0aW9uc1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2V4Y2VwdGlvbkluZm8nLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkV4Y2VwdGlvbkluZm9Bcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkV4Y2VwdGlvbkluZm9SZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6IHN0cmluZywgYXJncz86IGFueSkgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuUmVzcG9uc2U+O1xuXG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6IHN0cmluZywgYXJncz86IGFueSk6IFByb21pc2U8RGVidWdQcm90b2NvbC5SZXNwb25zZT4ge1xuXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChjb21wbGV0ZURpc3BhdGNoLCBlcnJvckRpc3BhdGNoKSA9PiB7XG5cdFx0XHR0aGlzLmRvU2VuZChjb21tYW5kLCBhcmdzLCAocmVzdWx0OiBEZWJ1Z1Byb3RvY29sLlJlc3BvbnNlKSA9PiB7XG5cdFx0XHRcdGlmIChyZXN1bHQuc3VjY2Vzcykge1xuXHRcdFx0XHRcdGNvbXBsZXRlRGlzcGF0Y2gocmVzdWx0KTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRlcnJvckRpc3BhdGNoKG5ldyBFcnJvcihyZXN1bHQubWVzc2FnZSkpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHR9KTtcblx0fVxuXG5cdHByaXZhdGUgZG9TZW5kKGNvbW1hbmQ6IHN0cmluZywgYXJnczogYW55LCBjbGI6IChyZXN1bHQ6IERlYnVnUHJvdG9jb2wuUmVzcG9uc2UpID0+IHZvaWQpOiB2b2lkIHtcblxuXHRcdGNvbnN0IHJlcXVlc3Q6IERlYnVnUHJvdG9jb2wuUmVxdWVzdCA9IHtcblx0XHRcdHR5cGU6ICdyZXF1ZXN0Jyxcblx0XHRcdHNlcTogdGhpcy5zZXF1ZW5jZSsrLFxuXHRcdFx0Y29tbWFuZDogY29tbWFuZFxuXHRcdH07XG5cdFx0aWYgKGFyZ3MgJiYgT2JqZWN0LmtleXMoYXJncykubGVuZ3RoID4gMCkge1xuXHRcdFx0cmVxdWVzdC5hcmd1bWVudHMgPSBhcmdzO1xuXHRcdH1cblxuXHRcdC8vIHN0b3JlIGNhbGxiYWNrIGZvciB0aGlzIHJlcXVlc3Rcblx0XHR0aGlzLnBlbmRpbmdSZXF1ZXN0cy5zZXQocmVxdWVzdC5zZXEsIGNsYik7XG5cblx0XHRjb25zdCBqc29uID0gSlNPTi5zdHJpbmdpZnkocmVxdWVzdCk7XG5cdFx0dGhpcy5vdXRwdXRTdHJlYW0ud3JpdGUoYENvbnRlbnQtTGVuZ3RoOiAke0J1ZmZlci5ieXRlTGVuZ3RoKGpzb24sICd1dGY4Jyl9XFxyXFxuXFxyXFxuJHtqc29ufWAsICd1dGY4Jyk7XG5cdH1cblxuXHRwcml2YXRlIGhhbmRsZURhdGEoZGF0YTogQnVmZmVyKTogdm9pZCB7XG5cblx0XHR0aGlzLnJhd0RhdGEgPSBCdWZmZXIuY29uY2F0KFt0aGlzLnJhd0RhdGEsIGRhdGFdKTtcblxuXHRcdHdoaWxlICh0cnVlKSB7XG5cdFx0XHRpZiAodGhpcy5jb250ZW50TGVuZ3RoID49IDApIHtcblx0XHRcdFx0aWYgKHRoaXMucmF3RGF0YS5sZW5ndGggPj0gdGhpcy5jb250ZW50TGVuZ3RoKSB7XG5cdFx0XHRcdFx0Y29uc3QgbWVzc2FnZSA9IHRoaXMucmF3RGF0YS50b1N0cmluZygndXRmOCcsIDAsIHRoaXMuY29udGVudExlbmd0aCk7XG5cdFx0XHRcdFx0dGhpcy5yYXdEYXRhID0gdGhpcy5yYXdEYXRhLnNsaWNlKHRoaXMuY29udGVudExlbmd0aCk7XG5cdFx0XHRcdFx0dGhpcy5jb250ZW50TGVuZ3RoID0gLTE7XG5cdFx0XHRcdFx0aWYgKG1lc3NhZ2UubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRcdFx0dGhpcy5kaXNwYXRjaChtZXNzYWdlKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0Y29udGludWU7XHQvLyB0aGVyZSBtYXkgYmUgbW9yZSBjb21wbGV0ZSBtZXNzYWdlcyB0byBwcm9jZXNzXG5cdFx0XHRcdH1cblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGNvbnN0IGlkeCA9IHRoaXMucmF3RGF0YS5pbmRleE9mKFByb3RvY29sQ2xpZW50LlRXT19DUkxGKTtcblx0XHRcdFx0aWYgKGlkeCAhPT0gLTEpIHtcblx0XHRcdFx0XHRjb25zdCBoZWFkZXIgPSB0aGlzLnJhd0RhdGEudG9TdHJpbmcoJ3V0ZjgnLCAwLCBpZHgpO1xuXHRcdFx0XHRcdGNvbnN0IGxpbmVzID0gaGVhZGVyLnNwbGl0KCdcXHJcXG4nKTtcblx0XHRcdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRcdFx0XHRjb25zdCBwYWlyID0gbGluZXNbaV0uc3BsaXQoLzogKy8pO1xuXHRcdFx0XHRcdFx0aWYgKHBhaXJbMF0gPT09ICdDb250ZW50LUxlbmd0aCcpIHtcblx0XHRcdFx0XHRcdFx0dGhpcy5jb250ZW50TGVuZ3RoID0gK3BhaXJbMV07XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdHRoaXMucmF3RGF0YSA9IHRoaXMucmF3RGF0YS5zbGljZShpZHggKyBQcm90b2NvbENsaWVudC5UV09fQ1JMRi5sZW5ndGgpO1xuXHRcdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRicmVhaztcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGRpc3BhdGNoKGJvZHk6IHN0cmluZyk6IHZvaWQge1xuXG5cdFx0Y29uc3QgcmF3RGF0YSA9IEpTT04ucGFyc2UoYm9keSk7XG5cblx0XHRpZiAodHlwZW9mIHJhd0RhdGEuZXZlbnQgIT09ICd1bmRlZmluZWQnKSB7XG5cdFx0XHRjb25zdCBldmVudCA9IDxEZWJ1Z1Byb3RvY29sLkV2ZW50PiByYXdEYXRhO1xuXHRcdFx0dGhpcy5lbWl0KGV2ZW50LmV2ZW50LCBldmVudCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnN0IHJlc3BvbnNlID0gPERlYnVnUHJvdG9jb2wuUmVzcG9uc2U+IHJhd0RhdGE7XG5cdFx0XHRjb25zdCBjbGIgPSB0aGlzLnBlbmRpbmdSZXF1ZXN0cy5nZXQocmVzcG9uc2UucmVxdWVzdF9zZXEpO1xuXHRcdFx0aWYgKGNsYikge1xuXHRcdFx0XHR0aGlzLnBlbmRpbmdSZXF1ZXN0cy5kZWxldGUocmVzcG9uc2UucmVxdWVzdF9zZXEpO1xuXHRcdFx0XHRjbGIocmVzcG9uc2UpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxufVxuIl19